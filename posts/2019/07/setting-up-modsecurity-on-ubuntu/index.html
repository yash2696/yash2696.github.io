<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8'>

<link href="https://gmpg.org/xfn/11" rel="profile">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">


<meta name="referrer" content="no-referrer">


 
<meta property="og:title" content="Setting Up ModSecurity on Ubuntu" />
<meta property="og:description"
      content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yashagarwal.in/posts/2019/07/setting-up-modsecurity-on-ubuntu/" />


    
        <meta property="article:published_time" content="2019-07-01T18:20:18&#43;05:30"/>
    
    
        <meta property="article:modified_time" content="2019-07-01T18:20:18&#43;05:30"/>
    







    



    






<!-- rel="me" links for IndieAuth -->

<link href="https://github.com/yashhere/" rel="me"><link href="https://gitlab.com/users/yashhere/projects" rel="me"><link href="https://twitter.com/yash__here/" rel="me"><link href="https://keybase.io/yash2696" rel="me"><link href="https://micro.blog/yagr" rel="me">


    
    
    <link rel="authorization_endpoint" href="https://micro.blog/indieauth/auth" />

    
    <link rel="token_endpoint" href="https://micro.blog/indieauth/token" />



    
    
        <link rel="pingback" href="https://webmention.io/yashagarwal.in/xmlrpc" />
        <link rel="webmention" href="https://webmention.io/yashagarwal.in/webmention" />
    
    
        <link rel="micropub" href="https://yashagarwal.in/micropub" />
    


 <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setting Up ModSecurity on Ubuntu"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@yash__here"/>
    <meta name="twitter:creator" content="@yash__here"/>







<meta name="hugo-build-date" content="2020-03-24T12:13:38Z"/>
<meta name="hugo-commit-hash" content="157669a0"/>
<meta name="generator" content="Hugo 0.68.3" />
    <title>Setting Up ModSecurity on Ubuntu • /dev/yash/notes</title>
    <link rel='canonical' href='https://yashagarwal.in/posts/2019/07/setting-up-modsecurity-on-ubuntu/'>
    

    
    <link rel='icon' href='/appicons/favicon.ico'>



    
        <link rel="preload" href="/fonts/libre-baskerville/2012/subset/LibreBaskerville-Regular.woff2" as="font" crossorigin>
    
        <link rel="preload" href="/fonts/iosevka/1.14.1/subset/iosevka-ss08-regular.woff2" as="font" crossorigin>
    
        <link rel="preload" href="/fonts/linux-libertine/5.3.0/subset/LinBiolinum_Rah.woff2" as="font" crossorigin>
    
        <link rel="preload" href="/fonts/source-sans-pro/2.020R-ro-1.075R-it/subset/SourceSansPro-Regular.woff2" as="font" crossorigin>
    









    <script>
         
        !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
         
        !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
    </script>



<style>
    
    
    :root {
        --theme-color: #6a9fb5;
        --theme-color-light: rgba(106, 159, 181, 0.2);
    }
    
    html {
        line-height: 1.5;
    }
</style>














<link rel="stylesheet" href="/styles.min.f6565ee3d38818c0a84d443af627f6b5033cf64b069e8527c2b2a05af03ac7c0.css" integrity="sha256-9lZe49OIGMCoTUQ69if2tQM89ksGnoUnwrKgWvA6x8A=">







    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.da6b5b4da09d91a8af30baf04214409c80aeae536efdd0622d169644a02f7e6d.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.58d47dcaa2ba2c5b650ea35c1155248de2aff6efe389ada218b0101b4a1f3fff.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.72101f3ce24cd49875bf0159cfd78e64dea181370d779f442bedef2023a1969b.png">
    <link rel="manifest" href="/manifest.3d290f98d0c4ee23e14b3c829d3f492989299740875ba45a51549445fcd1874f.json">
    <link rel="mask-icon" href="/safari-pinned-tab.12bcf28d5986de6bb989d2e4a8c6b84e0c723dae4c62fa5f91d5c1f94d69b3be.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d" />
    <meta name="theme-color" content="#ffffff" />




<link rel="alternate" type="application/jf2post+json" href="https://yashagarwal.in/posts/2019/07/setting-up-modsecurity-on-ubuntu/jf2post.json" title="Jf2post for /dev/yash/notes" />

 

     



    
    
    
        
    


     
    
    <meta name="DC.Creator" content="Yash Agarwal"/>
    


</head>

<body lang="en">
    <div class="border" id="home"></div>
    <div class="wrapper">   
        
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://yashagarwal.in/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://yashagarwal.in/notes/">Notes</a></li>
            
        
            
                <li><a class="" href="https://yashagarwal.in/whoami/">Whoami</a></li>
            
        
            
                <li><a class="" href="https://yashagarwal.in/search/">Search</a></li>
            
        
    </ul>
</nav>


<div class="container">
    <header class="masthead">
        <div class="masthead-title no-text-decoration">
            <a href="/">/dev/yash/notes</a> 
        </div>
        <div class="masthead-tagline">
            The directory of my thoughts
        </div>
    </header>


        








<article class="post h-entry posts">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__technical__"
                                
                                
                                title="See all 14 posts categorized in ‘Technical’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/categories/technical/">Technical</a>
                            </li>
                        
                    
                </ul>
            
         
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__linux__"
                                
                                
                                title="See all 2 posts tagged with ‘Linux’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/tags/linux/">Linux</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">Setting Up ModSecurity on Ubuntu</h1>

        
        <data class="u-url" value="https://yashagarwal.in/posts/2019/07/setting-up-modsecurity-on-ubuntu/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2019-07-01T18:20:18+0530" class="dt-published">Mon Jul 1, 2019</time>
        
        
    </div>


            




        </div>
         

     



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://yashagarwal.in/" class="u-author">Yash Agarwal</a>
        </span>
    


    </header>

    <div class="content">
        


        





                       


        <div class="e-content">
            




<p>Recently, I am experimenting with Web Application Firewalls a lot. ModSecurity is one of them. It is the most famous and useful open-source Web Application Firewall (WAF) in existence. It is supported by various web servers such as Apache, Nginx, and IIS.</p>
<p>The job of ModSecurity is to sit in front of the application web server and check the incoming requests and outgoing responses to filter out malicious content. It does so by the use of powerful and complex regular expressions. ModSecurity uses a rule language for its rules. The rule language has variables and operators defined to aid in the process of parsing HTTP requests.</p>
<p>ModSecurity, in itself, cannot block or allow requests. It is just a rule engine. It requires rules to operate appropriately. That&rsquo;s where its sister project, Core Rule Set (CRS), comes into the picture. CRS is a rule set developed to be used with ModSecurity. It has been in active development for several years now and is very mature. Together, ModSecurity and CRS form a formidable defense against the widespread web application attacks.</p>
<p>Now that you know, what a WAF is, let&rsquo;s proceed to install ModSecurity on Ubuntu. I will be compiling ModSecurity&rsquo;s latest version on Ubuntu 18.04. We will also configure ModSecurity to use Core Rule Set.</p>
<h2 id="installing-dependencies">Installing Dependencies&nbsp;<a class="headline-hash no-text-decoration" href="#installing-dependencies">#</a> </h2>
<p>ModSecurity requires some dependencies to work correctly. Let&rsquo;s install them -</p>
<p>First, upgrade the Ubuntu system.</p>
<div class="highlight-wrapper">
    <div class="highlight-before">bash</div>
    
        <div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt-get -y update
sudo apt-get -y upgrade</code></pre></div>
    
</div>
<p>Now install the dependencies.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt-get -y install git libtool dh-autoreconf pkgconf gawk libcurl4-gnutls-dev libexpat1-dev libpcre3-dev libssl-dev libxml2-dev libyajl-dev zlibc zlib1g-dev libxml2 libpcre++-dev libxml2-dev libgeoip-dev liblmdb-dev lua5.2-dev iputils-ping locales apache2 apache2-dev ca-certificates wget</code></pre></div>
<p><em>Optional</em>: clean up the Ubuntu caches.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt-get clean <span class="o">&amp;&amp;</span> sudo rm -rf /var/lib/apt/lists/*</code></pre></div>
<p>Install <code>SSDeep</code> as well (as done <a href="https://github.com/CRS-support/modsecurity-docker/blob/v3/apache-apache/Dockerfile">here</a>)</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~
git clone https://github.com/ssdeep-project/ssdeep
<span class="nb">cd</span> ssdeep
./bootstrap
./configure
make
sudo make install</code></pre></div>
<h2 id="compiling-modsecurity">Compiling ModSecurity&nbsp;<a class="headline-hash no-text-decoration" href="#compiling-modsecurity">#</a> </h2>
<p>Let&rsquo;s clone ModSecurity from Github.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~
git clone -b v3/master --single-branch https://github.com/SpiderLabs/ModSecurity
<span class="nb">cd</span> ModSecurity
git submodule init
git submodule update
./build.sh
./configure
make                <span class="c1"># takes ~8 minutes on AWS t2.micro</span>
sudo make install</code></pre></div>
<h2 id="compiling-modsecurity-apache-connector">Compiling ModSecurity-apache connector&nbsp;<a class="headline-hash no-text-decoration" href="#compiling-modsecurity-apache-connector">#</a> </h2>
<p>To configure it with Apache, we will require ModSecurity-apache connector. Let&rsquo;s install that as well.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~
git clone https://github.com/SpiderLabs/ModSecurity-apache
<span class="nb">cd</span> ModSecurity-apache
./autogen.sh
./configure --with-libmodsecurity<span class="o">=</span>/usr/local/modsecurity
make
sudo make install</code></pre></div>
<h2 id="setting-up-crs-rules">Setting up CRS rules&nbsp;<a class="headline-hash no-text-decoration" href="#setting-up-crs-rules">#</a> </h2>
<p>Now, let&rsquo;s download CRS rule set as well.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~
git clone -b v3.2/dev https://github.com/SpiderLabs/owasp-modsecurity-crs
sudo mv owasp-modsecurity-crs/ /usr/local/</code></pre></div>
<p>Rename CRS configuration file -</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo mv /usr/local/owasp-modsecurity-crs/crs-setup.conf.example /usr/local/owasp-modsecurity-crs/crs-setup.conf</code></pre></div>
<h2 id="setting-up-modsecurity">Setting up ModSecurity&nbsp;<a class="headline-hash no-text-decoration" href="#setting-up-modsecurity">#</a> </h2>
<p>Now, we need to create a file in the Apache modules directory, so that Apache can know, how to activate ModSecurity.</p>
<p>Create <code>/etc/apache2/mods-enabled/security3.conf</code> file and paste the following contents -</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">LoadModule security3_module /usr/lib/apache2/modules/mod_security3.so
modsecurity on
modsecurity_rules_file <span class="s1">&#39;/etc/apache2/modsec/main.conf&#39;</span></code></pre></div>
<p>As you can see, the last line in the above code block reference a file <code>main.conf</code> in a folder <code>modsec</code>. This folder will not be present by default. We need to create that.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo mkdir -p /etc/apache2/modsec</code></pre></div>
<p>Setup ModSecurity configuration file -</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># enables Unicode support in ModSecurity</span>
sudo wget -P /etc/apache2/modsec/ https://raw.githubusercontent.com/SpiderLabs/ModSecurity/v3/master/unicode.mapping

sudo wget -P /etc/apache2/modsec/ https://raw.githubusercontent.com/SpiderLabs/ModSecurity/v3/master/modsecurity.conf-recommended
sudo mv /etc/apache2/modsec/modsecurity.conf-recommended /etc/apache2/modsec/modsecurity.conf</code></pre></div>
<p>Change the SecRuleEngine directive in the configuration to change from the default &ldquo;detection only&rdquo; mode to actively dropping malicious traffic.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo sed -i <span class="s1">&#39;s/SecRuleEngine DetectionOnly/SecRuleEngine On/&#39;</span> /etc/apache2/modsec/modsecurity.conf</code></pre></div>
<p>Change the location of <code>modsec_audit.log</code> file to Apache log directory.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo sed -i <span class="s1">&#39;s/SecAuditLog \/var\/log\/modsec_audit.log/SecAuditLog \/var\/log\/apache2\/modsec_audit.log/&#39;</span> /etc/apache2/modsec/modsecurity.conf</code></pre></div>
<p>To configure ModSecurity to use CRS rule set, put the following text in <code>/etc/apache2/modsec/main.conf</code> file.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Include <span class="s2">&#34;/etc/apache2/modsec/modsecurity.conf&#34;</span>
Include <span class="s2">&#34;/usr/local/owasp-modsecurity-crs/crs-setup.conf&#34;</span>
Include <span class="s2">&#34;/usr/local/owasp-modsecurity-crs/rules/*.conf&#34;</span></code></pre></div>
<p>Also enable some Apache modules for better functioning of ModSecurity.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo a2enmod unique_id headers rewrite actions dav dav_fs</code></pre></div>
<p>Now restart the Apache server</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo systemctl restart apache2</code></pre></div>
<h2 id="fixing-some-common-issues">Fixing some common issues&nbsp;<a class="headline-hash no-text-decoration" href="#fixing-some-common-issues">#</a> </h2>
<p>Sometimes, I had encountered errors when ModSecurity was not able to append logs to its log file. I figured out that ModSecurity did not have enough permissions to write that file. We can fix this issue quickly.</p>
<p>First, test if you really have this issue or not.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">curl <span class="s1">&#39;http://localhost/?q=&#34;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&#39;</span>
&lt;!DOCTYPE HTML PUBLIC <span class="s2">&#34;-//IETF//DTD HTML 2.0//EN&#34;</span>&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;403 Forbidden&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Forbidden&lt;/h1&gt;
&lt;p&gt;You dont have permission to access / on this server.&lt;br /&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;address&gt;Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span> Server at localhost Port 80&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;</code></pre></div>
<p>Now go to Apache log directory and check the contents of <code>modsec_audit.log</code> file.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /var/log/apache2
tail modsec_audit.log</code></pre></div>
<p>You should see the following content -</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">---0LzdyETA---A--
<span class="o">[</span>01/Jul/2019:14:42:41 +0000<span class="o">]</span> 156199216179.666171 127.0.0.1 <span class="m">41824</span> ip-xxx-xx-xx-xx.ap-south-1.compute.internal <span class="m">80</span>
---0LzdyETA---B--
GET /?q<span class="o">=</span><span class="s2">&#34;&gt;&lt;script&gt;alert(1)&lt;/script&gt; HTTP/1.1
</span><span class="s2">Host: localhost
</span><span class="s2">User-Agent: curl/7.58.0
</span><span class="s2">Accept: */*
</span><span class="s2">
</span><span class="s2">---TqjMwy7h---D--
</span><span class="s2">
</span><span class="s2">---TqjMwy7h---F--
</span><span class="s2">HTTP/1.1 403
</span><span class="s2">
</span><span class="s2">---TqjMwy7h---H--
</span><span class="s2">ModSecurity: Warning. detected XSS using libinjection. [file &#34;</span>/usr/local/owasp-modsecurity-crs/rules/REQUEST-941-APPLICATION-ATTACK-XSS.conf<span class="s2">&#34;] [line &#34;</span>37<span class="s2">&#34;] [id &#34;</span>941100<span class="s2">&#34;] [rev &#34;&#34;] [msg &#34;</span>XSS Attack Detected via libinjection<span class="s2">&#34;] [data &#34;</span>Matched Data: XSS data found within ARGS:q: <span class="s2">&#34;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&#34;</span><span class="o">]</span> <span class="o">[</span>severity <span class="s2">&#34;2&#34;</span><span class="o">]</span> <span class="o">[</span>ver <span class="s2">&#34;OWASP_CRS/3.1.0&#34;</span><span class="o">]</span> <span class="o">[</span>maturity <span class="s2">&#34;0&#34;</span><span class="o">]</span> <span class="o">[</span>accuracy <span class="s2">&#34;0&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;application-multi&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;language-multi&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;platform-multi&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;attack-xss&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;OWASP_CRS/WEB_ATTACK/XSS&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;WASCTC/WASC-8&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;WASCTC/WASC-22&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;OWASP_TOP_10/A3&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;OWASP_AppSensor/IE1&#34;</span><span class="o">]</span> <span class="o">[</span>tag <span class="s2">&#34;CAPEC-242&#34;</span><span class="o">]</span> <span class="o">[</span>hostname <span class="s2">&#34;localhost&#34;</span><span class="o">]</span> <span class="o">[</span>uri <span class="s2">&#34;/&#34;</span><span class="o">]</span> <span class="o">[</span>unique_id <span class="s2">&#34;156198848361.198287&#34;</span><span class="o">]</span> <span class="o">[</span>ref <span class="s2">&#34;v8,27t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls&#34;</span><span class="o">]</span>
....
....

---TqjMwy7h---I--

---TqjMwy7h---J--

---TqjMwy7h---Z--</code></pre></div>
<p>If you do not see the following content, and the file is empty or it does not exist, then ModSecurity was not able to open this file for writing. Use the following fix -</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># find out the user, Apache is running as</span>
<span class="nv">apache_user</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>ps -ef <span class="p">|</span> egrep <span class="s1">&#39;(httpd|apache2|apache)&#39;</span> <span class="p">|</span> grep -v <span class="sb">`</span>whoami<span class="sb">`</span> <span class="p">|</span> grep -v root <span class="p">|</span> head -n1 <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="s2">&#34;</span></code></pre></div>
<p>Now, change the owner of Apache log directory to <code>apache_user</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo chown -R <span class="nv">$apache_user</span>:<span class="nv">$apache_user</span> /var/log/apache2/*</code></pre></div>
<p>Now, ModSecurity should be able to append logs to the file <code>modsec_audit.log</code>.</p>
<h2 id="bonus-enabling-json-logs"><em>Bonus</em>: Enabling JSON logs&nbsp;<a class="headline-hash no-text-decoration" href="#bonus-enabling-json-logs">#</a> </h2>
<p><strong>Note:</strong> Honestly speaking, I was not able to make it work every time. I do not know what is the issue, but it works with some of the installations, and with some of the installations, it just doesn&rsquo;t log anything to the <code>audit</code> directory. If anyone has managed to make it work consistently, please let me know.</p>
<p>Anyway, if you are like me, who do not like the default ModSecurity log format, ModSecurity provides an option to generate logs in JSON format as well. To enable JSON support, the YAJL library should be installed. We already installed this package when we were installing dependencies, so our ModSecurity setup is compiled with JSON support. Let us now configure ModSecurity to generate JSON logs.</p>
<p>Open the <code>/etc/apache2/modsec/modsecurity.conf</code> file and find the following lines -</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">SecAuditLogType           Serial
SecAuditLog               /var/log/modsec_audit.log</code></pre></div>
<p>Once you have found the following lines, replace these lines with the following lines</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">SecAuditLogFormat         JSON
SecAuditLogType           Parallel
SecAuditLog               /var/log/apache2/modsec_audit.log
SecAuditLogStorageDir     /var/log/apache2/audit/

SecAuditLogFileMode       <span class="m">0644</span>
SecAuditLogDirMode        <span class="m">0755</span></code></pre></div>
<p>Restart Apache server</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo systemctl restart apache2</code></pre></div>
<p>Now, go to <code>/var/log/apache2/</code> directory and create <code>audit</code> folder.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /var/log/apache2
sudo mkdir audit

<span class="c1"># make `apache_user` owner of this directory as well...</span>
sudo chown -R <span class="nv">$apache_user</span>:<span class="nv">$apache_user</span> /var/log/apache2/audit</code></pre></div>
<p>Now, ModSecurity should be able to generate JSON logs in this directory. ModSecurity generates logs in the following format -</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">ubuntu@server:/var/log/apache2$ tree audit
audit
└── 20190701
    ├── 20190701-1132
    │   ├── 20190701-113225-156196094515.868593
    │   └── 20190701-113226-156196094691.154769
    ├── 20190701-1211
    │   ├── 20190701-121122-156196328239.048942
    │   └── 20190701-121122-156196328243.018882

    ....
    ....</code></pre></div>
<p>Now, your site should be relatively more secure than before.</p>
<h2 id="a-warning-though">A warning, though&nbsp;<a class="headline-hash no-text-decoration" href="#a-warning-though">#</a> </h2>
<p>CRS is known to generate a lot of false-positive when enabled completely. We have not touched CRS paranoia levels. By default, it is set to paranoia level 1, which is known to produce false positives rarely, but still, as a measure of precaution, monitor your site&rsquo;s traffic for some time, and then decide if you need to disable some of the CRS rules or not.</p>


        </div>
    </div>
</article>



        <footer>
            




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#installing-dependencies">Installing Dependencies</a></li>
    <li><a href="#compiling-modsecurity">Compiling ModSecurity</a></li>
    <li><a href="#compiling-modsecurity-apache-connector">Compiling ModSecurity-apache connector</a></li>
    <li><a href="#setting-up-crs-rules">Setting up CRS rules</a></li>
    <li><a href="#setting-up-modsecurity">Setting up ModSecurity</a></li>
    <li><a href="#fixing-some-common-issues">Fixing some common issues</a></li>
    <li><a href="#bonus-enabling-json-logs"><em>Bonus</em>: Enabling JSON logs</a></li>
    <li><a href="#a-warning-though">A warning, though</a></li>
  </ul>
</nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    



<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__technical__"
                                
                                
                                title="See all 14 posts categorized in ‘Technical’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/categories/technical/">Technical</a>
                            </li>
                        
                    
                </ul>
            
         
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__linux__"
                                
                                
                                title="See all 2 posts tagged with ‘Linux’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/tags/linux/">Linux</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://yashagarwal.in/posts/2019/07/automatic-https-certs-using-godaddy-and-gitlab-apis/" class="nobr">« Automatic HTTPS Certs Using GoDaddy and Gitlab APIs</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://yashagarwal.in/posts/2019/06/travelogue-chikmagalur/" class="nobr">Travelogue - Chikmagalur »</a>
        </span>
    
</div>


<a id="bottom"></a>





    
    
        <div class="send-mention">
            <p>
                If you have written a <a href="https://indieweb.org/responses">response</a>
                to this, enter your response post's URL below.
            </p>
	    <form action="https://webmention.io/yashagarwal.in/webmention" method="post">
	    <input name="source" placeholder="https://example.com/reply-to-setting-up-modsecurity-on-ubuntu/" type="url">
	    <input name="target" value="https://yashagarwal.in/posts/2019/07/setting-up-modsecurity-on-ubuntu/" type="hidden">
	    <input value="Send Webmention" type="submit">
	    </form>
        </div>

        
        <div class="comment">
            <div class="instructions left">
                <p>
                    Or, you can send a "comment" webmention (it's OK if
                    you don't know what that means). <em>When asked about your
                    website on an IndieAuth login screen, simply type
                    <code>https://commentpara.de</code>.</em>
                </p>
                <small>
                    <span class="small-caps">Markdown Support</span>&mdash;
                    <span class="nobr"><code>**</code><b>bold</b><code>**</code></span>,
                    <span class="nobr"><code>_</code><i>italics</i><code>_</code></span>,
                    <span class="nobr"><code>~~</code><del>strikethrough</del><code>~~</code></span>,
                    <span class="nobr"><code>[</code><i>descr</i><code>]</code><code>(</code><i>link</i><code>)</code></span>,
                    <span class="nobr"><code>`</code><code>monospace</code><code>`</code></span>,
                    <span class="nobr"><code>```</code><a href="https://gohugo.io/content-management/syntax-highlighting/#list-of-chroma-highlighting-languages"><strong><code>LANG</code></strong></a><code>\nline1\nline2\n</code><code>```</code></span> <em>(Yep, multi-line code blocks too, with syntax highlighting!)</em>,
                    auto-hyperlinking.
                </small>
            </div>
            <form method="get" action="https://quill.p3k.io/" target="_blank">
                <input type="hidden" name="dontask" value="1" />
                <input type="hidden" name="me" value="https://commentpara.de/" />
                <input type="hidden" name="reply" value="https://yashagarwal.in/posts/2019/07/setting-up-modsecurity-on-ubuntu/" />
                <input type="submit" value="Write a comment" />
            </form>
            <div class="clear-float"></div>
        </div>
    






    
    
    
        <h2 id="webmentions">Webmentions&nbsp;<a class="headline-hash no-text-decoration" href="#webmentions">#</a></h2>
        
        
        
        
        
        
        

        
        

        
            
                
                
                
                
                
                
                
                
                
                 
                    
                
                
                
                    
                        
                        <dl class="webmention mention" data-proofer-ignore>
                            <dt>
                                Mentioned at
                            </dt>
                            <dd>
                                <a href="https://yashagarwal.in/" class="no-text-decoration">https://yashagarwal.in/</a>
                            </dd>
                        </dl>
                    
                       
             
             

        


        
        <span class="like no-text-decoration">
            
            
            
            
            
            
        </span>

        
        <span class="retweet no-text-decoration">
            
            
            
            
            
            
        </span>

        
        
                       
                       




    <div class="comments clear-float">
        <hr />
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yashhere" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


     
            <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

            <div class='copyright'>
    <p>
    </p>
</div>
        </footer>
        <hr />
        </div> 
    </div>
    <footer> 
        

<ul class="social no-text-decoration">
    
        <li>
            <a href="https://github.com/yashhere/" title="Github">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-github"></i>
                
            </a>
        </li>
    
        <li>
            <a href="https://gitlab.com/users/yashhere/projects" title="Gitlab">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-gitlab"></i>
                
            </a>
        </li>
    
        <li>
            <a href="https://twitter.com/yash__here/" title="Twitter">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-twitter"></i>
                
            </a>
        </li>
    
        <li>
            <a href="https://keybase.io/yash2696" title="Keybase.io">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-keybase"></i>
                
            </a>
        </li>
    
        <li>
            <a href="https://micro.blog/yagr" title="MicroBlog">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-microblog"></i>
                
            </a>
        </li>
    
</ul>






    
    
    
        
    
    
    
        
            
            
                
            
        
    
    
    
        
            
        
    





 
    
    



<p class="generated no-text-decoration">
    Generated using <a href="https://github.com/yashhere/refined-mod"><code class="nobr">modified</code></a> <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/157669a0">0.68.3</a></span><br /><span class="nobr">&mdash; Markdown <a href="https://gitlab.com/yashhere/yashhere.gitlab.io/raw/source/content/posts/2019-07-01-setting-up-modsecurity-on-ubuntu/index.md">source</a> of this page</span>.
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    
        <a href="https://indieweb.org/">
            
            <img src="/images/indieweb-badge--optimized.85cbb2d5598063662c9f65a33ee6992a7d615e69db2f17e36b4c9ccc24f6c11d.png"
                 width="80" height=15
                 alt="IndieWebCamp" class="pixelated">
        </a>

        
        <span class="nobr">
            <a href="https://pin13.net/mf2/?url=https://yashagarwal.in/posts/2019/07/setting-up-modsecurity-on-ubuntu/">
                
                
                
                <img src="/images/microformats-badge--optimized.b042280ef440edb0af5e57d3df3d7ffee11eaeeaed90daa9b0fd2908e2a06175.png"
                     width="80" height=15
                     alt="Microformats2" class="pixelated"></a>
                <a href="http://microformats.org/about" data-proofer-ignore>?</a>
        </span>

        
            <a href="https://xn--sr8hvo.ws/㊗️🍋👨‍👨‍👧‍👧/previous">←</a>
            <a href="https://xn--sr8hvo.ws/" title="An IndieWeb Webring">🕸💍</a>
            <a href="https://xn--sr8hvo.ws/㊗️🍋👨‍👨‍👧‍👧/next">→</a>
        

        
            <a href="https://indieweb.org/Webmention">
                
                <img src="/images/webmention-badge--optimized.1f1e67798047d7011a0600fe93f12fc8882878f7d222e3adfcbb56b54f6adc44.png"
                     width=80 height=15
                     alt="Webmention" class="pixelated">
            </a>
        
    

    
        
        
        <a href="https://html5.validator.nu/?doc=https://yashagarwal.in/posts/2019/07/setting-up-modsecurity-on-ubuntu/&amp;showsource=yes">
            
            <img src="/images/html5-css3-semantics-badge--scaled-optimized.0f343c79b5f793c32b308b8b872fccdc6f8f10dc328d12f3f8fba203ab3ccc6e.png"
                 width="46" height="18" class="pixelated"
                 alt="HTML5 Powered with CSS3 / Styling, and Semantics"
                 title="HTML5 Powered with CSS3 / Styling, and Semantics">
        </a>
    
</div>








    <div class="h-card">
        
            
            <img class="u-photo" alt="Photo of Yash Agarwal"
                 src="/author/yash.e3d59580e47f1217b0742aa49fa060981c576d4126c9ee24de57366ebe3d8dc4.jpg" width="400" height="400">
        
        
        <a class="p-name u-url" href="https://yashagarwal.in/">Yash Agarwal</a>
        
            <p>
                <a class="u-email" href="mailto:yashagarwaljpr@gmail.com" rel="me">yashagarwaljpr@gmail.com</a>
            </p>
        
        
    </div>



    </footer>










    
    

    
    <link rel="preload" href="/js/global.min.1c8008426616c8b99f14066c43c634f6b85dc268f119b1a69f2574e9fc739c75.js" as="script" integrity="sha256-HIAIQmYWyLmfFAZsQ8Y09rhdwmjxGbGmnyV06fxznHU=">
    <script defer src="/js/global.min.1c8008426616c8b99f14066c43c634f6b85dc268f119b1a69f2574e9fc739c75.js" integrity="sha256-HIAIQmYWyLmfFAZsQ8Y09rhdwmjxGbGmnyV06fxznHU="></script>






<script integrity="sha256-FUxGS3zNAWzWj0bjXJCUw2BPYX6x9keSW5UpBqQXdaU=">function _httpsAlways(){if(location.protocol=='http:'&&(location.hostname!="127.0.0.1"&&location.hostname!="localhost"))
location.href=location.href.replace("http","https");}
function _notGitLab(domainTo=true){var x=location.hostname.search("gitlab.io")!=-1?true:false;if(x){location.href=domainTo;}}
function _notGitHub(domainTo=true){var x=location.hostname.search("github.io")!=-1?true:false;if(x){location.href=domainTo;}}
_notGitLab("https://yashagarwal.in");_notGitHub("https://yashagarwal.in");_httpsAlways();</script>



<script>
     
     
     window.addEventListener('DOMContentLoaded', function() {
         var nav=responsiveNav("#nav");
     });
</script>
</body>
</html>