<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8'>

<link href="https://gmpg.org/xfn/11" rel="profile">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">


<meta name="referrer" content="no-referrer">


 
<meta property="og:title" content="Go &#43; gRPC &#43; OPA - A Perfect Union - Part 3" />
<meta property="og:description"
      content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-3/" />


    
        <meta property="article:published_time" content="2019-02-18T06:47:15&#43;05:30"/>
    
    
        <meta property="article:modified_time" content="2019-02-18T06:47:15&#43;05:30"/>
    







    
        
            
            
        
    



    






<!-- rel="me" links for IndieAuth -->

<link href="https://github.com/yashhere/" rel="me">


    
    
    <link rel="authorization_endpoint" href="https://indieauth.com/auth" data-proofer-ignore>
    
    
    <link rel="token_endpoint" href="https://tokens.indieauth.com/token">




 <meta name="twitter:card" content="summary"/><meta name="twitter:image" content="/android-chrome-512x512.db28abcc591bd775d661d3fdb11c7c9e71d5e5fa81728f383b1a36c25c683bae.png"/>
<meta name="twitter:title" content="Go &#43; gRPC &#43; OPA - A Perfect Union - Part 3"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@yash__here"/>
    <meta name="twitter:creator" content="@yash__here"/>





<meta name="hugo-build-date" content="2020-03-24T12:13:38Z"/>
<meta name="hugo-commit-hash" content="157669a0"/>
<meta name="generator" content="Hugo 0.68.3" />
    <title>Go &#43; gRPC &#43; OPA - A Perfect Union - Part 3 • /dev/yash/notes</title>
    <link rel='canonical' href='https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-3/'>
    

    
    <link rel='icon' href='/favicon.ico'>



    
        <link rel="preload" href="/fonts/libre-baskerville/2012/subset/LibreBaskerville-Regular.woff2" as="font" crossorigin>
    
        <link rel="preload" href="/fonts/iosevka/1.14.1/subset/iosevka-ss08-regular.woff2" as="font" crossorigin>
    
        <link rel="preload" href="/fonts/linux-libertine/5.3.0/subset/LinBiolinum_Rah.woff2" as="font" crossorigin>
    
        <link rel="preload" href="/fonts/source-sans-pro/2.020R-ro-1.075R-it/subset/SourceSansPro-Regular.woff2" as="font" crossorigin>
    









    <script>
         
        !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
         
        !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
    </script>



<style>
    
    
    :root {
        --theme-color: #6a9fb5;
        --theme-color-light: rgba(106, 159, 181, 0.2);
    }
    
    html {
        line-height: 1.5;
    }
</style>














<link rel="stylesheet" href="/styles.min.15fd0b6e02e8ee12d83e881e2534f306dc69495d71be498824f554b1b13fbf54.css" integrity="sha256-Ff0LbgLo7hLYPogeJTTzBtxpSV1xvkmIJPVUsbE/v1Q=">







    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.da6b5b4da09d91a8af30baf04214409c80aeae536efdd0622d169644a02f7e6d.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.58d47dcaa2ba2c5b650ea35c1155248de2aff6efe389ada218b0101b4a1f3fff.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.72101f3ce24cd49875bf0159cfd78e64dea181370d779f442bedef2023a1969b.png">
    <link rel="manifest" href="/manifest.bbc56ff464bdd48b6d8b7ac25ace729fb4ab976ddc589fabac051358ccb5c6ca.json">
    <link rel="mask-icon" href="/safari-pinned-tab.12bcf28d5986de6bb989d2e4a8c6b84e0c723dae4c62fa5f91d5c1f94d69b3be.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d" />
    <meta name="theme-color" content="#ffffff" />




<link rel="alternate" type="application/jf2post+json" href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-3/jf2post.json" title="Jf2post for /dev/yash/notes" />

 

     



    
    
    
        
    


     
    
    <meta name="DC.Creator" content="Yash Agarwal"/>
    


</head>

<body lang="en">
    <div class="border" id="home"></div>
    <div class="wrapper">   
        
<nav id="nav" class="nav-collapse opened" aria-hidden="false">
    <ul class="navbar">
        <li><a class="" href="/">Home</a></li>
        
            
                <li><a class="" href="https://yashagarwal.in/posts/">Posts</a></li>
            
        
            
                <li><a class="" href="https://yashagarwal.in/notes/">Notes</a></li>
            
        
            
                <li><a class="" href="https://yashagarwal.in/whoami/">Whoami</a></li>
            
        
            
                <li><a class="" href="https://yashagarwal.in/search/">Search</a></li>
            
        
    </ul>
</nav>


<div class="container">
    <header class="masthead">
        <div class="masthead-title no-text-decoration">
            <a href="/">/dev/yash/notes</a> <span class="blinking-cursor">❚</span>
        </div>
        <div class="masthead-tagline">
            The directory of my thoughts
        </div>
    </header>


        








<article class="post h-entry posts">
    <header>
        <div class="center">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__technical__"
                                
                                
                                title="See all 14 posts categorized in ‘Technical’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/categories/technical/">Technical</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline series">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__go-&#43;-grpc-&#43;-opa__"
                                
                                
                                title="See all 3 posts in ‘Go &#43; gRPC &#43; OPA’ series"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/series/go-&#43;-grpc-&#43;-opa/">Go &#43; gRPC &#43; OPA</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__grpc__"
                                
                                
                                title="See all 3 posts tagged with ‘GRPC’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/tags/grpc/">GRPC</a>
                            </li>
                        
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__opa__"
                                
                                
                                title="See all 3 posts tagged with ‘OPA’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/tags/opa/">OPA</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>

        <h1 class="post-title p-name">Go &#43; gRPC &#43; OPA - A Perfect Union - Part 3</h1>

        
        <data class="u-url" value="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-3/"></data>

        <div class="date-syndication">
            


    
    
    <div class="post-date">
        
        <time datetime="2019-02-18T06:47:15+0530" class="dt-published">Mon Feb 18, 2019</time>
        
        
    </div>


            




        </div>
         

     



    
    
    
        
    


    
        
        <span class="hide">
            &mdash; <a href="https://yashagarwal.in/" class="u-author">Yash Agarwal</a>
        </span>
    


    </header>

    <div class="content">
        


        






    
    
    
    
    
    
        
        
        
            <div class="series">
                <p>
                    <a href="#" id="series"></a>
                    This is a post in the
                    
                        “<b class="p-category">Go &#43; gRPC &#43; OPA</b>”
                    
                    series.
                </p>
                <table>
                    
                    
                        
                        
                            
                            <tr class="active"><td class="date">2019-02-18</td><td>Go &#43; gRPC &#43; OPA - A Perfect Union - Part 3</td></tr>
                        
                    
                        
                        
                            <tr><td class="date">2019-02-17</td><td><a href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-2/">Go &#43; gRPC &#43; OPA - A Perfect Union - Part 2</a></td></tr>
                        
                    
                        
                        
                            <tr><td class="date">2019-02-10</td><td><a href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-1/">Go &#43; gRPC &#43; OPA - A Perfect Union - Part 1</a></td></tr>
                        
                       
                    
                </table>
            </div>
            <br />
                       
                       
                       


        <div class="e-content">
            




<p>I finished my last <a href="/posts/2019/02/go-grpc-opa-a-perfect-union-part-2/">post</a> with the following issue -</p>
<blockquote>
<p>Now, here one problem arises, how to make sure that the search results will not return any book which the user is not
authorized to access. We will solve this problem using OPA in the next and last post of this series.</p>
</blockquote>
<p>Let&rsquo;s solve this issue now. We will use OPA&rsquo;s declarative language, Rego, to implement policies which will decide on the
basis of some user-provided data, which all objects are to be returned to the user.</p>
<p>We will also define a list of all the users who are part of this library. Here we are hardcoding this data, as I did
not want to waste my time in implementing a user registration service, but this functionality is not very important from
our point of view. We will require only one field from this users data - the <code>user_type</code> field. This field will
determine what the access level for the user is. We have already added the <code>access_level</code> field in the <code>Book</code> definition
of our proto file.</p>
<p>When the user wants to search for a particular book, it will provide its <code>user_type</code> the ISBN of the book to our service. Our service
will take that ISBN and pass it to the OPA server. OPA server already has the <code>Book</code> data and the <code>User</code> data. Now it has
the required ISBN to query the Book data. The Rego policy will query the Book data by ISBN. It will also
check for the <code>access_level</code> condition. Moreover, after this operation, it will return the resultant set of books that satisfy both the requirements.</p>
<p>Here is the Rego policy -</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">package</span> <span class="n">library</span>

<span class="n">import</span> <span class="n">data</span><span class="o">.</span><span class="n">books</span>
<span class="n">import</span> <span class="n">data</span><span class="o">.</span><span class="n">users</span>
<span class="n">import</span> <span class="n">input</span>

<span class="n">search_books</span><span class="o">[</span><span class="n">book</span><span class="o">]</span> <span class="p">{</span>
  <span class="n">input</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">isbn</span> <span class="o">==</span> <span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="n">isbn</span>
  <span class="n">input</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">user_type</span> <span class="o">&gt;=</span> <span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="n">access_level</span>
  <span class="n">book</span> <span class="o">=</span> <span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>
<span class="p">}</span>

<span class="n">list_all_books</span><span class="o">[</span><span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">]]</span> <span class="p">{</span>
  <span class="n">input</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">user_type</span> <span class="o">&gt;=</span> <span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="n">access_level</span>
<span class="p">}</span></code></pre></div>
<p>The user data is <a href="https://github.com/yashhere/go-library-service/blob/master/OPA/users.json">here</a> and the book data is <a href="https://github.com/yashhere/go-library-service/blob/master/add_books.sh">here</a>.</p>
<p>A sample <code>input</code> request is shown below -</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;book&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;isbn&#34;</span><span class="p">:</span> <span class="s2">&#34;1128959038&#34;</span>
        <span class="p">},</span>
        <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;user_type&#34;</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>The <code>input</code> is the data that the user is providing. In <code>search_books</code> function, the input ISBN is matched with the ISBN
of all books one by one. Then the resultant set of books is filtered by <code>user_type</code> and <code>access_level</code> (these
two fields are essentially the same). In the last, the resultant set of books is assigned to the variable <code>book</code> which
will be returned to the gRPC service.</p>
<p>The <code>list_all_books</code> function is implemented similarly. The only difference is that we do not need to filter the books
by ISBN. Filtering by <code>access_level</code> is enough.</p>
<p>Now our library service is completed. It is a very basic service. The intention was to show that the decision-making process can be offloaded to the OPA to reduce the complexity of the services. In this example, the advantages might not
be obvious, but in large production environments, where many services are running, it can make a significant
difference.</p>
<p>The code for this series can be found on my <a href="https://github.com/yashhere/go-library-service">Github</a> account.</p>
<p>I hope you liked the article. Share your views and suggestions in the comments.</p>
<p>Thanks for reading. Cheers :)</p>


        </div>
    </div>
</article>



        <footer>
            




<div class="no-text-decoration">
    <div class="jump top"><a href="#" title="Top of this page">⮉</a></div>
    <div class="jump bottom"><a href="#bottom" title="Bottom of this page">⮋</a></div>
</div>


 
    
        <div class="hugotoc no-text-decoration">
            <nav id="TableOfContents"></nav>
            <a href="#" class="back-to-top">Back to top</a>
        </div>
    



<div class="backtotop center no-text-decoration">
    <a href="#">back to <span class="top">top</span></a>
</div>


<div class="right">
    <div class="taxo no-text-decoration">
         
            
                <ul class="no-bullets inline categories">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__technical__"
                                
                                
                                title="See all 14 posts categorized in ‘Technical’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/categories/technical/">Technical</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline series">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__go-&#43;-grpc-&#43;-opa__"
                                
                                
                                title="See all 3 posts in ‘Go &#43; gRPC &#43; OPA’ series"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/series/go-&#43;-grpc-&#43;-opa/">Go &#43; gRPC &#43; OPA</a>
                            </li>
                        
                    
                </ul>
            
         
            
                <ul class="no-bullets inline tags">
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__grpc__"
                                
                                
                                title="See all 3 posts tagged with ‘GRPC’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/tags/grpc/">GRPC</a>
                            </li>
                        
                    
                        
                        
                        
                            
                            
                            
                            
                            
                            <li class="__opa__"
                                
                                
                                title="See all 3 posts tagged with ‘OPA’"
                                
                            >
                                <a class="p-category" href="https://yashagarwal.in/tags/opa/">OPA</a>
                            </li>
                        
                    
                </ul>
            
        
    </div>

</div>
<div class="clear-float"></div>



<div class="prev-next-navigator clear-float">
    
        <span class="prev-post left no-text-decoration">
            <a href="https://yashagarwal.in/posts/2019/06/travelogue-chikmagalur/" class="nobr">« Travelogue - Chikmagalur</a>
        </span>
    
    
        <span class="next-post right no-text-decoration">
            <a href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-2/" class="nobr">Go &#43; gRPC &#43; OPA - A Perfect Union - Part 2 »</a>
        </span>
    
</div>


<a id="bottom"></a>









                       




    <div class="comments clear-float">
        <hr />
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yashhere" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>


     
            <ul class="no-bullets feed right inline">
    
        
        
    
</ul>
<div class="clear-float"></div>

            <div class='copyright'>
    <p>
    </p>
</div>
        </footer>
        <hr />
        </div> 
    </div>
    <footer> 
        

<ul class="social no-text-decoration">
    
        <li>
            <a href="https://github.com/yashhere/" title="Github">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-github"></i>
                
            </a>
        </li>
    
        <li>
            <a href="https://gitlab.com/users/yashhere/projects" title="Gitlab">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-gitlab"></i>
                
            </a>
        </li>
    
        <li>
            <a href="https://twitter.com/yash__here/" title="Twitter">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-twitter"></i>
                
            </a>
        </li>
    
        <li>
            <a href="https://keybase.io/yash2696" title="Keybase.io">
                
                
                    
                    
                    
                    <i class="fab fa-2x fa-keybase"></i>
                
            </a>
        </li>
    
</ul>






    
    
    
        
    
    
    
        
            
            
                
            
        
    
    
    
        
            
        
    





 
    
    



<p class="generated no-text-decoration">
    Generated using <a href="https://github.com/yashhere/refined-mod"><code class="nobr">modified</code></a> <a href="https://gitlab.com/kaushalmodi/hugo-theme-refined"><code class="nobr">hugo-theme-refined</code></a> + <span class="nobr">Hugo <a href="https://github.com/gohugoio/hugo/commit/157669a0">0.68.3</a></span><br /><span class="nobr">&mdash; Markdown <a href="https://gitlab.com/yashhere/yashhere.gitlab.io/raw/source/content/posts/2019-02-18-go-grpc-opa-a-perfect-union-part-3/index.md">source</a> of this page</span>.
</p>

<p>
    
</p>




<div class="badges no-text-decoration">
    
    

    
        
        
        <a href="https://html5.validator.nu/?doc=https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-3/&amp;showsource=yes">
            
            <img src="/images/html5-css3-semantics-badge--scaled-optimized.0f343c79b5f793c32b308b8b872fccdc6f8f10dc328d12f3f8fba203ab3ccc6e.png"
                 width="46" height="18" class="pixelated"
                 alt="HTML5 Powered with CSS3 / Styling, and Semantics"
                 title="HTML5 Powered with CSS3 / Styling, and Semantics">
        </a>
    
</div>








    <div class="h-card">
        
            
            <img class="u-photo" alt="Photo of Yash Agarwal"
                 src="/author/yash.2842f98c30eaf22e6f1f7bbe38ac8d584cd916ec640e15b3aaf512b6d56ea8e2.jpg" width="400" height="400">
        
        
        <a class="p-name u-url" href="https://yashagarwal.in/">Yash Agarwal</a>
        
            <p>
                <a class="u-email" href="mailto:yashagarwaljpr@gmail.com" rel="me">yashagarwaljpr@gmail.com</a>
            </p>
        
        
    </div>



    </footer>










    
        
        

        
        <link rel="preload" href="/js/global.min.1c8008426616c8b99f14066c43c634f6b85dc268f119b1a69f2574e9fc739c75.js" as="script" integrity="sha256-HIAIQmYWyLmfFAZsQ8Y09rhdwmjxGbGmnyV06fxznHU=">
        <script src="/js/global.min.1c8008426616c8b99f14066c43c634f6b85dc268f119b1a69f2574e9fc739c75.js" integrity="sha256-HIAIQmYWyLmfFAZsQ8Y09rhdwmjxGbGmnyV06fxznHU="></script>
    





<link rel="preload" href="/js/redirection.min.154c464b7ccd016cd68f46e35c9094c3604f617eb1f647925b952906a41775a5.js" as="script">
<script src="/js/redirection.min.154c464b7ccd016cd68f46e35c9094c3604f617eb1f647925b952906a41775a5.js"></script>





<script>var nav=responsiveNav("#nav");</script>
</body>
</html>