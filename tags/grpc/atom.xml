<?xml version="1.0" encoding="utf-8"?> 
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-us">
    <generator uri="https://gohugo.io/" version="0.68.3">Hugo</generator><title type="html"><![CDATA[GRPC on /dev/yash/notes]]></title>
    
        <subtitle type="html"><![CDATA[The directory of my thoughts]]></subtitle>
    
    
    
            <link href="https://yashagarwal.in/tags/grpc/" rel="alternate" type="text/html" title="HTML" />
            <link href="https://yashagarwal.in/tags/grpc/index.xml" rel="alternate" type="application/rss+xml" title="RSS" />
            <link href="https://yashagarwal.in/tags/grpc/atom.xml" rel="self" type="application/atom+xml" title="Atom" />
            <link href="https://yashagarwal.in/tags/grpc/jf2feed.json" rel="alternate" type="application/jf2feed+json" title="jf2feed" />
    <updated>2020-04-04T10:53:07+00:00</updated>
    
    
    <author>
            <name>Yash Agarwal</name>
            
                <email>yashagarwaljpr@gmail.com</email>
            </author>
    
        <id>https://yashagarwal.in/tags/grpc/</id>
    
        
        <entry>
            <title type="html"><![CDATA[Go + gRPC + OPA - A Perfect Union - Part 3]]></title>
            <link href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-3/?utm_source=atom_feed" rel="alternate" type="text/html" />
            
                <link href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-2/?utm_source=atom_feed" rel="related" type="text/html" title="Go &#43; gRPC &#43; OPA - A Perfect Union - Part 2" />
                <link href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-1/?utm_source=atom_feed" rel="related" type="text/html" title="Go &#43; gRPC &#43; OPA - A Perfect Union - Part 1" />
            
                <id>https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-3/</id>
            
            
                    <author>
                        <name>Yash Agarwal</name>
                    </author>
            <published>2019-02-18T06:47:15+05:30</published>
            <updated>2019-02-18T06:47:15+05:30</updated>
            
            
            <content type="html"><![CDATA[<p>I finished my last <a href="/posts/2019/02/go-grpc-opa-a-perfect-union-part-2/">post</a> with the following issue -</p>
<blockquote>
<p>Now, here one problem arises, how to make sure that the search results will not return any book which the user is not
authorized to access. We will solve this problem using OPA in the next and last post of this series.</p>
</blockquote>
<p>Let&rsquo;s solve this issue now. We will use OPA&rsquo;s declarative language, Rego, to implement policies which will decide on the
basis of some user-provided data, which all objects are to be returned to the user.</p>
<p>We will also define a list of all the users who are part of this library. Here we are hardcoding this data, as I did
not want to waste my time in implementing a user registration service, but this functionality is not very important from
our point of view. We will require only one field from this users data - the <code>user_type</code> field. This field will
determine what the access level for the user is. We have already added the <code>access_level</code> field in the <code>Book</code> definition
of our proto file.</p>
<p>When the user wants to search for a particular book, it will provide its <code>user_type</code> the ISBN of the book to our service. Our service
will take that ISBN and pass it to the OPA server. OPA server already has the <code>Book</code> data and the <code>User</code> data. Now it has
the required ISBN to query the Book data. The Rego policy will query the Book data by ISBN. It will also
check for the <code>access_level</code> condition. Moreover, after this operation, it will return the resultant set of books that satisfy both the requirements.</p>
<p>Here is the Rego policy -</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">package</span> <span class="n">library</span>

<span class="n">import</span> <span class="n">data</span><span class="o">.</span><span class="n">books</span>
<span class="n">import</span> <span class="n">data</span><span class="o">.</span><span class="n">users</span>
<span class="n">import</span> <span class="n">input</span>

<span class="n">search_books</span><span class="o">[</span><span class="n">book</span><span class="o">]</span> <span class="p">{</span>
  <span class="n">input</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">isbn</span> <span class="o">==</span> <span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="n">isbn</span>
  <span class="n">input</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">user_type</span> <span class="o">&gt;=</span> <span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="n">access_level</span>
  <span class="n">book</span> <span class="o">=</span> <span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>
<span class="p">}</span>

<span class="n">list_all_books</span><span class="o">[</span><span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">]]</span> <span class="p">{</span>
  <span class="n">input</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">user_type</span> <span class="o">&gt;=</span> <span class="n">books</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="n">access_level</span>
<span class="p">}</span></code></pre></div>
<p>The user data is <a href="https://github.com/yashhere/go-library-service/blob/master/OPA/users.json">here</a> and the book data is <a href="https://github.com/yashhere/go-library-service/blob/master/add_books.sh">here</a>.</p>
<p>A sample <code>input</code> request is shown below -</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;book&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;isbn&#34;</span><span class="p">:</span> <span class="s2">&#34;1128959038&#34;</span>
        <span class="p">},</span>
        <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;user_type&#34;</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>The <code>input</code> is the data that the user is providing. In <code>search_books</code> function, the input ISBN is matched with the ISBN
of all books one by one. Then the resultant set of books is filtered by <code>user_type</code> and <code>access_level</code> (these
two fields are essentially the same). In the last, the resultant set of books is assigned to the variable <code>book</code> which
will be returned to the gRPC service.</p>
<p>The <code>list_all_books</code> function is implemented similarly. The only difference is that we do not need to filter the books
by ISBN. Filtering by <code>access_level</code> is enough.</p>
<p>Now our library service is completed. It is a very basic service. The intention was to show that the decision-making process can be offloaded to the OPA to reduce the complexity of the services. In this example, the advantages might not
be obvious, but in large production environments, where many services are running, it can make a significant
difference.</p>
<p>The code for this series can be found on my <a href="https://github.com/yashhere/go-library-service">Github</a> account.</p>
<p>I hope you liked the article. Share your views and suggestions in the comments.</p>
<p>Thanks for reading. Cheers :)</p>
]]></content>
            
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/categories/technical" term="technical" label="Technical" />
                            
                        
                    
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/series/go-&#43;-grpc-&#43;-opa" term="go-&#43;-grpc-&#43;-opa" label="Go &#43; gRPC &#43; OPA" />
                            
                        
                    
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/tags/grpc" term="grpc" label="GRPC" />
                             
                                <category scheme="https://yashagarwal.in/tags/opa" term="opa" label="OPA" />
                            
                        
                    
                
            
        </entry>
    
        
        <entry>
            <title type="html"><![CDATA[Go + gRPC + OPA - A Perfect Union - Part 2]]></title>
            <link href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-2/?utm_source=atom_feed" rel="alternate" type="text/html" />
            
                <link href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-1/?utm_source=atom_feed" rel="related" type="text/html" title="Go &#43; gRPC &#43; OPA - A Perfect Union - Part 1" />
            
                <id>https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-2/</id>
            
            
                    <author>
                        <name>Yash Agarwal</name>
                    </author>
            <published>2019-02-17T14:44:56+05:30</published>
            <updated>2019-02-17T14:44:56+05:30</updated>
            
            
            <content type="html"><![CDATA[



    

    
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />

    
    <link rel="stylesheet" href="/css/photoswipe.min.d780348a887d97b4d6cc664301a2941706e4a02aeb1533524fcce3b7b9b64b4f.css">

    

    
    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
        
        <div class="pswp__bg"></div>
        
        <div class="pswp__scroll-wrap">
            
            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>
            
            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    
                    <div class="pswp__counter"></div>
                    <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                    <button class="pswp__button pswp__button--share" title="Share"></button>
                    <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                    <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                    
                    
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                            <div class="pswp__preloader__cut">
                                <div class="pswp__preloader__donut"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div>
                </div>
                <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
                </button>
                <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
                </button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>
        </div>
    </div>

<p>In the last <a href="/posts/2019/02/go-grpc-opa-a-perfect-union-part-1/">post</a>, we discussed about the structure of our library
application. In this post, we will define the data definitions using protobuf, and then we will use these definitions to
create a Go service. We will also add a REST interface to the service. So let&rsquo;s get started.</p>
<h2 id="defining-proto-definitions">Defining Proto Definitions</h2>
<p>gRPC uses protocol buffers for serializing structured data. To define the structure of the data that you want to serialize, we use a <em>proto</em> file - it is a simple text file that contains all the logical pieces of your data in the form of <em>messages</em>, and the methods that will be called over the network. To know more about the syntax of proto files, visit <a href="https://grpc.io/docs/guides/">this</a> link.</p>
<p>I have defined the following proto file -</p>
<div class="highlight"><pre class="chroma"><code class="language-proto" data-lang="proto"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="kn">package</span> <span class="nn">library</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;google/api/annotations.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">service</span> <span class="n">LibraryService</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">ListAllBooks</span><span class="p">(</span><span class="n">QueryFormat</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Books</span><span class="p">)</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>      <span class="n">post</span> <span class="o">:</span> <span class="s">&#34;/listBooks&#34;</span><span class="err">
</span><span class="err"></span>      <span class="n">body</span> <span class="o">:</span> <span class="s">&#34;*&#34;</span><span class="err">
</span><span class="err"></span>    <span class="p">};</span><span class="err">
</span><span class="err"></span>  <span class="p">};</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">AddBook</span><span class="p">(</span><span class="n">QueryFormat</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Response</span><span class="p">)</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>      <span class="n">post</span> <span class="o">:</span> <span class="s">&#34;/addBook&#34;</span><span class="err">
</span><span class="err"></span>      <span class="n">body</span> <span class="o">:</span> <span class="s">&#34;*&#34;</span><span class="err">
</span><span class="err"></span>    <span class="p">};</span><span class="err">
</span><span class="err"></span>  <span class="p">};</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">SearchBook</span><span class="p">(</span><span class="n">QueryFormat</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Response</span><span class="p">)</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>      <span class="n">post</span> <span class="o">:</span> <span class="s">&#34;/searchBook&#34;</span><span class="err">
</span><span class="err"></span>      <span class="n">body</span> <span class="o">:</span> <span class="s">&#34;*&#34;</span><span class="err">
</span><span class="err"></span>    <span class="p">};</span><span class="err">
</span><span class="err"></span>  <span class="p">};</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c1">// the library
</span><span class="c1"></span><span class="kd">message</span> <span class="nc">Library</span> <span class="p">{</span> <span class="n">Books</span> <span class="n">books</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Books</span> <span class="p">{</span> <span class="k">repeated</span> <span class="n">Book</span> <span class="n">books</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c1">// metadata about a book
</span><span class="c1"></span><span class="kd">message</span> <span class="nc">Book</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">title</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">author</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">isbn</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">int32</span> <span class="n">no_of_copies</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">int32</span> <span class="n">access_level</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c1">// details about a user
</span><span class="c1"></span><span class="kd">message</span> <span class="nc">User</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kd">enum</span> <span class="n">UserType</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="c1">// https://github.com/golang/protobuf/issues/258
</span><span class="c1"></span>    <span class="n">GARBAGE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">Student</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">Administration</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">Faculty</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">int32</span> <span class="n">id_no</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="n">UserType</span> <span class="n">user_type</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">QueryFormat</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Response</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">action</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">int32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="k">oneof</span> <span class="n">value</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">User</span> <span class="n">user_data</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Empty</span> <span class="p">{}</span></code></pre></div>
<p>To compile it, run the following commands -</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">protoc -I/usr/local/include -I. <span class="se">\
</span><span class="se"></span>-I<span class="nv">$GOPATH</span>/src <span class="se">\
</span><span class="se"></span>-I<span class="nv">$GOPATH</span>/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis <span class="se">\
</span><span class="se"></span>--go_out<span class="o">=</span><span class="nv">plugins</span><span class="o">=</span>grpc:. <span class="se">\
</span><span class="se"></span>api/library.proto</code></pre></div>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">protoc -I/usr/local/include -I. <span class="se">\
</span><span class="se"></span>  -I<span class="nv">$GOPATH</span>/src <span class="se">\
</span><span class="se"></span>  -I<span class="nv">$GOPATH</span>/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis <span class="se">\
</span><span class="se"></span>  --grpc-gateway_out<span class="o">=</span><span class="nv">logtostderr</span><span class="o">=</span>true:. <span class="se">\
</span><span class="se"></span>  api/library.proto</code></pre></div>
<p>It will generate corresponding Golang definitions of the messages and services defined in the Proto file. These
definitions can be used by the server and client stubs to communicate with each other.</p>
<h2 id="implementation-of-go-service">Implementation of Go service</h2>
<p>Now we can start implementing the code for our services <code>AddBook()</code>, <code>ListAllBooks()</code> and <code>SearchBook()</code>. It is going to
be a very naive implementation of a library system, but it will be sufficient to learn all the concepts.</p>
<p>My implementation of the server stub is hosted
<a href="https://github.com/yashhere/go-library-service/blob/master/pkg/librarylib/server.go">here</a>. A basic flow diagram of
this implementation will look like this -</p>



    <link rel="stylesheet" href="/css/hugo-easy-gallery.css">
    


<div class="box fancy-figure caption-position-bottom caption-effect-appear" style="max-width:650px" itemscope itemtype="http://schema.org/ImageGallery">
    <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
        <div class="img">
            <img itemprop="thumbnail" src="/images/posts/2019-02-17/OPA_Service_Flow_Diagram.jpeg#center" alt="Architecture"/>
        </div>
        <a href="/images/posts/2019-02-17/OPA_Service_Flow_Diagram.jpeg#center" itemprop="contentUrl"></a>
    </figure>
</div>

<p>The gRPC server will listen on port <code>:50051</code>, and a REST HTTP server will listen on port <code>:8181</code>. The OPA server is
running on port <code>:8182</code>. The REST server is
implemented using <a href="https://github.com/grpc-ecosystem/grpc-gateway">gRPC-Gateway</a>. There are three methods - <code>AddBook()</code>,
<code>ListAllBooks()</code>, and <code>SearchBook()</code>. These methods can be called using either gRPC methods or using the REST endpoints
<code>/addBook</code>, <code>/listBooks</code> and <code>/searchBook</code>. By design, the library gRPC service will not implement the authentication
part of the service. The main purpose of using gRPC here is to provide a scalable and secure medium where all the
communication between client and server is happening in binary format, which is slightly more secure than the
traditional mediums. In the current form, this gRPC server will accept requests from everyone and execute the desired
functions. That is not desirable. What if a student tries to add a book to the library. Only Admins should be allowed to
execute such functions. What if someone who is not a student of the University tries to access the service. How to stop
them?</p>
<p>There are two steps to solve this issue -</p>
<ol>
<li>
<p><strong>Authentication</strong> - It mainly deals with the question - who are you? It is a way to gain access to the system by verifying your identity. In our case, a user will provide its username and password to access the library service.
Without this authentication, the user will not be able to access the system. We will not be implementing authentication
functionality in our application.</p>
</li>
<li>
<p><strong>Authorization</strong> - It deals with the question - which resources are you allowed to use? OPA can be used here to define various rights based on the access levels of the users.</p>
</li>
</ol>
<p>If you have noticed, I have defined an <code>access_level</code> field in the proto definition of the <code>Book</code>. This field will tell
us what is the minimum access level required for a user to access this book.</p>
<p>Again, in the proto definition of the <code>User</code>, I have defined a <code>user_type</code> field. This field will serve as an indicator of
the access rights of the user. In the real world, these access rights will be decided after the user has authenticated
herself to
the system, but here, we will hardcode the access rights.</p>
<p>So, only users with access rights equal to <code>Administration</code> will be allowed to add books to the system. Here we do not
care who the user is. If the user is supplying the correct access right, she will be allowed to operate.
The authentication logic in real-world scenarios will determine the <em>who</em> part.</p>
<p>There are some books in the library, which have access rights equal to that of a <code>Faculty</code>. It means that only faculties
will be allowed to access those books. The students will not be able to access these books, even while searching for
books using ISBN. This kind of mechanism can be implemented using OPA very quickly. We will see the implementation of the OPA
part in the next post.</p>
<p>While querying the service, users are required to supply their identity (at least <code>user_type</code>) and the book ISBN if
they are searching for some book. The administrators are supposed to provide the name, author, access level, number of copies, and ISBN while adding the books. I have not added the error checking functionality in the code, but it should be
easy enough to implement such functionality.</p>
<p>The <a href="https://github.com/yashhere/go-library-service/blob/master/cmd/main.go">main.go</a> file is the starting point of this service. It will spawn two servers in two Go Routines. Ideally, some synchronization mechanisms should be implemented in the code to avoid race conditions in some cases - for example, what will happen if two or more clients are trying to add the same book simultaneously. Here in our case, nothing serious
will happen, as OPA will take only one book per ISBN, and discard all the other books with the same ISBN even if the other
metadata is different (I designed the service in this way to keep the code easy enough to understand), but if there are
other operations like DeleteBook and IssueBook, then the race conditions can cause issues.</p>
<p>In the <code>AddBook()</code> function, the user provided book details will be sent to the OPA server using a REST call. OPA will
store this information in its in-memory store at a unique place determined by the ISBN of the book. In actual cases, the data should be stored in some persistent
storage, such as a DB. OPA will take the information from the DB. Again, to keep the implementation easy enough to
understand, we are not using any such persistent storage. If any other book with different metadata but the same ISBN comes,
then OPA will overwrite the existing book with the new one.</p>
<p>In the <code>SearchBook()</code> function, the user will provide the ISBN of the desired book. The gRPC service will call
the OPA using REST API and find if any such book exists or not.</p>
<p>The <code>ListAllBooks()</code> is different in the way that it does not need any ISBN.</p>
<p>Now, here one problem arises, how to make sure that the search results will not return any book which the user is not
authorized to access. We will solve this problem using OPA in the next and last post of this series.</p>
<p>I hope that this post was helpful. If you have any doubts or want to say anything else, please comment. It will be a great
motivation and appreciation for me.</p>
<p>Thanks for reading. Cheers 😄</p>
]]></content>
            
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/categories/technical" term="technical" label="Technical" />
                            
                        
                    
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/series/go-&#43;-grpc-&#43;-opa" term="go-&#43;-grpc-&#43;-opa" label="Go &#43; gRPC &#43; OPA" />
                            
                        
                    
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/tags/grpc" term="grpc" label="GRPC" />
                             
                                <category scheme="https://yashagarwal.in/tags/opa" term="opa" label="OPA" />
                            
                        
                    
                
            
        </entry>
    
        
        <entry>
            <title type="html"><![CDATA[Go + gRPC + OPA - A Perfect Union - Part 1]]></title>
            <link href="https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-1/?utm_source=atom_feed" rel="alternate" type="text/html" />
            
            
                <id>https://yashagarwal.in/posts/2019/02/go-grpc-opa-a-perfect-union-part-1/</id>
            
            
                    <author>
                        <name>Yash Agarwal</name>
                    </author>
            <published>2019-02-10T14:29:08+05:30</published>
            <updated>2019-02-10T14:29:08+05:30</updated>
            
            
            <content type="html"><![CDATA[<p><strong>TL;DR</strong> &ndash; In a series of blog posts, I will be implementing a simple library application supporting both gRPC and REST interfaces using Go, gRPC, and
OPA. My approach might not be the most optimal one, but I am learning these technologies currently. Please give your
valuable suggestions and be kind :)</p>
<p>I have been learning the basics of microservices and Golang lately. On the work front, I got a chance to work on Go, gRPC, and Open
Policy Agent as my first professional project. In this post, I will be demonstrating what I learned in the last few months.
We will be implementing a simple gRPC based library service, which will be able to serve
requests using both gRPC and REST calls. It will also incorporate the Open Policy Agent (OPA) to provide the authorization
to users. Let&rsquo;s begin with a quick introduction to gRPC and OPA.</p>
<h2 id="grpc">gRPC</h2>
<p>gRPC is Google&rsquo;s implementation for Remote Procedure Calls(RPC). RPC is mainly used in building scalable distributed systems. While REST has a limited set of verbs, RPC can define any function calls, including synchronous and asynchronous calls.</p>
<p>In gRPC, the client can make procedure calls as if the requests are made to some local function. However, the underlying client
stub (auto-generated) will send the call to the server. The server will have a similar server stub, which will be able to
handle the requests coming from the client. The server will send the response to the client using similar mechanisms
over the network. All the communication is serialized to binary format, so it is ideal for distributed systems as binary format
tends to be on the faster side for large amounts of data.</p>
<p>For more info about gRPC, visit the official <a href="https://grpc.io/">website</a>.</p>
<h2 id="open-policy-agent-opa">Open Policy Agent (OPA)</h2>
<p>OPA gives us the ability to define a fine-grained policy control mechanism. However, I think the most critical benefit of
using OPA is that it gives you the ability to decouple your services and the definition of policies from the enforcement
of it.</p>
<p>There are mainly two parts of OPA -</p>
<ol>
<li>A JSON document store where you can define anything from your users, access roles,
permission levels, etc.</li>
<li>A policy is written in a declarative language. This policy gives you new derivative data from the original JSON document store evaluated by the policy. The declarative language is called Rego, and these policies are also documents that generate results according to the defined policy. The users query these results.</li>
</ol>
<p>This info will be sufficient for our use case. More info about it can be found at the official
<a href="https://www.openpolicyagent.org/">website</a>.</p>
<h2 id="the-skeleton-of-our-application">The skeleton of our Application</h2>
<p>We will be building a command-line library application. This application will support adding, deleting, searching, issuing, and returning of
books. There are three types of users &ndash; student, faculties, and staff. Not all users have a similar kind of access level. There are some books which are only reserved for students, and some are exclusively reserved for faculties and so on.</p>
<p>I think emulating the <a href="https://harrypotter.fandom.com/wiki/Hogwarts_Library">library</a> at Hogwarts will be a good idea here. Students and ordinary people were not allowed inside
the restricted section of the library. We will emulate that restricted section using the authorization mechanisms
provided by OPA.</p>
<p>The gRPC protocol will handle the communications part in our app, but not everyone in Hogwarts is using gRPC. Wizards
are still in love with REST (not a bad thing, though), so we will provide them alike the REST interface to interact
with our service. We do not want to face the wrath of the wizards, after all.</p>
<p>OPA can either be used as a standalone application or be embedded in the Go service as well. Both approaches have
their pros and cons. I have decided to use OPA as an independent service, as it will be more comfortable that way for us to push
authorization data and policies to it if such a need arises in the future.</p>
<p>One more issue remains - where to store the added books. Shall we persist them? In practical scenarios, persistence is
always a good idea, but here I do not want to complicate things too much. We could use any Object storage servers (e.g., Minio) to
store the JSON data generated from our gRPC methods, but that will unnecessarily add complexity to our simple scenario.
Wizards do not like complicate stuff, you know!</p>
<p>In the next posts, we will define our gRPC proto file and build the Go service around it. Then we will add a REST
interface to our service for simple CRUD operations in our application. Then we will add OPA authorization to restrict
our users from adding and viewing books which they are not supposed to access.</p>
<p>Thank you for reading. Cheers 😊</p>
]]></content>
            
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/categories/technical" term="technical" label="Technical" />
                            
                        
                    
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/series/go-&#43;-grpc-&#43;-opa" term="go-&#43;-grpc-&#43;-opa" label="Go &#43; gRPC &#43; OPA" />
                            
                        
                    
                 
                    
                         
                        
                            
                             
                                <category scheme="https://yashagarwal.in/tags/grpc" term="grpc" label="GRPC" />
                             
                                <category scheme="https://yashagarwal.in/tags/opa" term="opa" label="OPA" />
                            
                        
                    
                
            
        </entry>
    
</feed>
